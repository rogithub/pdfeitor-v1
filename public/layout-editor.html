<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pdfeitor V1: Editor de Layouts</title>
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <aside id="controls">
        <h1>Editor de Collage</h1>
        <p class="info-text" style="margin-top: -10px; margin-bottom: 20px;">
            <a href="/">&#8592; Volver al Menú</a>
        </p>
        
        <div class="control-group">                            
            <h3>1. Configuración de Página</h3>
            <div>
                <label for="pageSize">Tamaño de Página</label>
                <select id="pageSize" name="pageSize">
                    <option value="letter" selected>Carta</option>
                    <option value="legal">Oficio</option>
                </select>
            </div>                            
            <div style="margin-top: 15px;">
                <label for="orientation">Orientación</label>
                <select id="orientation" name="orientation">
                    <option value="portrait" selected>Vertical</option>
                    <option value="landscape">Horizontal</option>
                </select>
            </div>                            
            <div style="margin-top: 15px;">
                <label for="margin">Margen de Página (mm)</label>
                <input type="number" id="margin" name="margin" value="10" min="0">
            </div>
            <div style="margin-top: 15px;">
                <input type="checkbox" id="useHalfPage" name="useHalfPage">
                <label for="useHalfPage" style="display: inline-block;">Usar solo media página</label>
            </div>
        </div>

        <div class="control-group">
            <h3>2. Diseño de Cuadrícula</h3>
            <div>
                <label for="base-cols">Columnas</label>
                <input type="number" id="base-cols" value="2" min="1">
            </div>
            <div style="margin-top: 15px;">
                <label for="base-rows">Filas</label>
                <input type="number" id="base-rows" value="2" min="1">
            </div>
             <div style="margin-top: 15px;">
                <label for="spacing">Espaciado entre Celdas (mm)</label>
                <input type="number" id="spacing" name="spacing" value="5" min="0">
            </div>
            <button id="create-grid-btn">Aplicar Cuadrícula</button>
        </div>
        
        <div class="control-group">
            <h3>Acciones de Celda</h3>
            <p class="info-text">(Mantén <b>Ctrl</b> para seleccionar varias celdas)</p>
            <button id="merge-cells-btn" disabled>Combinar Celdas</button>
            <button id="split-cells-btn" class="btn-split" disabled>Separar Celda</button>
        </div>

        <div class="control-group" style="margin-top: auto;">
            <h3>3. Finalizar</h3>
            <button id="generate-pdf-btn" class="btn-generate">Generar PDF</button>
        </div>
    </aside>

    <main id="main-content">
        <div id="design-container">
            <div id="grid-container">
                <!-- Las celdas de la cuadrícula se generarán aquí -->
            </div>
        </div>
    </main>

    <div id="image-modal">
        <div class="modal-content">
            <h2>Editar Celda</h2>
            <label for="image-input">Seleccionar Imagen:</label>
            <input type="file" id="image-input" accept="image/*">
            <div id="image-preview-container">
                <img id="image-preview" src="" alt="Previsualización">
            </div>
            <div class="modal-actions">
                <button id="rotate-image-btn">Girar 90°</button>
                <button id="remove-image-btn" class="btn-remove">Quitar Imagen</button>
            </div>
            <div class="modal-actions">
                <button id="cancel-modal-btn" class="btn-cancel">Cancelar</button>
                <button id="save-image-btn" class="btn-generate">Guardar</button>
            </div>
        </div>
    </div>

    <script src="/js/constants.js"></script>
    <script src="/js/ui.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- ELEMENTOS DEL DOM ---
            const orientationSelect = document.getElementById('orientation');
            const pageSizeSelect = document.getElementById('pageSize');
            const useHalfPageCheckbox = document.getElementById('useHalfPage');
            const createGridBtn = document.getElementById('create-grid-btn');
            const baseColsInput = document.getElementById('base-cols');
            const baseRowsInput = document.getElementById('base-rows');
            const designContainer = document.getElementById('design-container');
            const gridContainer = document.getElementById('grid-container');
            const marginInput = document.getElementById('margin');
            const spacingInput = document.getElementById('spacing');
            const mergeBtn = document.getElementById('merge-cells-btn');
            const splitBtn = document.getElementById('split-cells-btn');
            const generatePdfBtn = document.getElementById('generate-pdf-btn');
            const mainContent = document.getElementById('main-content');

            // Modal elements
            const imageModal = document.getElementById('image-modal');
            const imageInput = document.getElementById('image-input');
            const imagePreview = document.getElementById('image-preview');
            const rotateBtn = document.getElementById('rotate-image-btn');
            const removeBtn = document.getElementById('remove-image-btn');
            const saveBtn = document.getElementById('save-image-btn');
            const cancelBtn = document.getElementById('cancel-modal-btn');

            let gridState = [];
            let selectedCellIds = new Set();
            let activeCellId = null;
            let currentRotation = 0;
            let currentImageFile = null;
            let px_per_mm = 1;

            // --- LÓGICA DE GENERACIÓN DE PDF ---

            async function generatePdf() {
                generatePdfBtn.disabled = true;
                generatePdfBtn.textContent = 'Generando...';

                const formData = new FormData();
                const visibleCells = [];
                let imageCounter = 0;

                gridState.forEach(cell => {
                    if (cell.visible) {
                        const cellData = {
                            col: cell.col,
                            row: cell.row,
                            colSpan: cell.colSpan,
                            rowSpan: cell.rowSpan,
                            rotation: 0,
                            imageName: null
                        };

                        if (cell.image.file) {
                            const imageName = `image_${imageCounter++}`;
                            cellData.imageName = imageName;
                            cellData.rotation = cell.image.rotation;
                            const renamedFile = new File([cell.image.file], imageName, { type: cell.image.file.type });
                            formData.append('images', renamedFile);
                        }
                        visibleCells.push(cellData);
                    }
                });

                const layoutData = {
                    pageSettings: {
                        orientation: orientationSelect.value,
                        pageSize: pageSizeSelect.value,
                        useHalfPage: useHalfPageCheckbox.checked,
                        margin: parseFloat(marginInput.value),
                        spacing: parseFloat(spacingInput.value),
                        baseCols: parseInt(baseColsInput.value, 10),
                        baseRows: parseInt(baseRowsInput.value, 10)
                    },
                    cells: visibleCells
                };

                formData.append('layout', JSON.stringify(layoutData));

                try {
                    const response = await fetch('/generate-layout', {
                        method: 'POST',
                        body: formData
                    });

                    if (!response.ok) throw new Error(`Error del servidor: ${response.statusText}`);

                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = url;
                    a.download = 'layout.pdf';
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();

                } catch (error) {
                    console.error('Error al generar el PDF:', error);
                    alert('Hubo un error al generar el PDF.');
                } finally {
                    generatePdfBtn.disabled = false;
                    generatePdfBtn.textContent = 'Generar PDF';
                }
            }

            // --- LÓGICA DE ESTADO Y RENDERIZADO ---

            function render() {
                px_per_mm = updateDesignArea({
                    pageSize: pageSizeSelect.value,
                    orientation: orientationSelect.value,
                    useHalfPage: useHalfPageCheckbox.checked,
                    margin: parseFloat(marginInput.value) || 0,
                    containerElement: designContainer,
                    areaElement: mainContent
                });
                renderGrid();
            }

            function createGrid() {
                const cols = parseInt(baseColsInput.value, 10) || 1;
                const rows = parseInt(baseRowsInput.value, 10) || 1;
                
                gridState = [];
                selectedCellIds.clear();

                for (let r = 0; r < rows; r++) {
                    for (let c = 0; c < cols; c++) {
                        gridState.push({
                            id: r * cols + c, col: c, row: r, colSpan: 1, rowSpan: 1,
                            visible: true, merged: false, mergedInto: null,
                            image: { file: null, url: null, rotation: 0 }
                        });
                    }
                }
                render();
                updateActionButtons();
            }

            function renderGrid() {
                const cols = parseInt(baseColsInput.value, 10) || 1;
                const rows = parseInt(baseRowsInput.value, 10) || 1;
                const spacing_mm = parseFloat(spacingInput.value) || 0;
                const spacing_px = spacing_mm * px_per_mm;

                gridContainer.innerHTML = '';
                gridContainer.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
                gridContainer.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
                gridContainer.style.gap = `${spacing_px}px`;

                gridState.forEach(cellState => {
                    if (!cellState.visible) return;

                    const cell = document.createElement('div');
                    cell.classList.add('grid-cell');
                    cell.dataset.id = cellState.id;
                    
                    cell.style.gridColumn = `span ${cellState.colSpan}`;
                    cell.style.gridRow = `span ${cellState.rowSpan}`;

                    const imageContainer = document.createElement('div');
                    imageContainer.classList.add('image-container');

                    if (cellState.image.url) {
                        imageContainer.style.backgroundImage = `url(${cellState.image.url})`;
                        imageContainer.style.transform = `rotate(${cellState.image.rotation}deg)`;
                    }

                    if (selectedCellIds.has(cellState.id)) {
                        cell.classList.add('selected');
                    }
                    
                    cell.appendChild(imageContainer);
                    gridContainer.appendChild(cell);
                });
            }

            // --- LÓGICA DE ACCIONES (CELDA) ---

            function handleCellClick(e) {
                const cell = e.target.closest('.grid-cell');
                if (!cell) return;

                const id = parseInt(cell.dataset.id, 10);
                const isCtrlPressed = e.ctrlKey || e.metaKey;

                if (isCtrlPressed) {
                    if (selectedCellIds.has(id)) selectedCellIds.delete(id);
                    else selectedCellIds.add(id);
                } else {
                    selectedCellIds.clear();
                    openImageModal(id);
                }
                
                renderGrid();
                updateActionButtons();
            }

            function mergeCells() {
                if (selectedCellIds.size < 2) return;
                const selectedCells = Array.from(selectedCellIds).map(id => gridState[id]);
                const minRow = Math.min(...selectedCells.map(c => c.row));
                const maxRow = Math.max(...selectedCells.map(c => c.row));
                const minCol = Math.min(...selectedCells.map(c => c.col));
                const maxCol = Math.max(...selectedCells.map(c => c.col));
                const colSpan = maxCol - minCol + 1;
                const rowSpan = maxRow - minRow + 1;

                if (selectedCells.length !== colSpan * rowSpan) {
                    alert('La selección debe formar un rectángulo perfecto.');
                    return;
                }

                const anchorCell = gridState.find(c => c.row === minRow && c.col === minCol);
                anchorCell.colSpan = colSpan;
                anchorCell.rowSpan = rowSpan;
                anchorCell.merged = true;

                selectedCells.forEach(cell => {
                    if (cell.id !== anchorCell.id) {
                        cell.visible = false;
                        cell.mergedInto = anchorCell.id;
                    }
                });

                selectedCellIds.clear();
                selectedCellIds.add(anchorCell.id);
                renderGrid();
                updateActionButtons();
            }

            function splitCell() {
                if (selectedCellIds.size !== 1) return;
                const anchorId = selectedCellIds.values().next().value;
                const anchorCell = gridState[anchorId];
                if (!anchorCell || !anchorCell.merged) return;

                gridState.forEach(cell => {
                    if (cell.mergedInto === anchorId) {
                        cell.visible = true;
                        cell.mergedInto = null;
                    }
                });

                anchorCell.colSpan = 1;
                anchorCell.rowSpan = 1;
                anchorCell.merged = false;

                selectedCellIds.clear();
                renderGrid();
                updateActionButtons();
            }

            // --- LÓGICA DEL MODAL DE IMAGEN ---

            function openImageModal(id) {
                activeCellId = id;
                const cellState = gridState[activeCellId];
                currentRotation = cellState.image.rotation;
                currentImageFile = cellState.image.file;
                imagePreview.src = cellState.image.url || '';
                imagePreview.style.transform = `rotate(${currentRotation}deg)`;
                imageInput.value = '';
                imageModal.style.display = 'flex';
            }

            function closeModal() {
                imageModal.style.display = 'none';
                activeCellId = null;
            }

            function handleImageUpload(e) {
                const file = e.target.files[0];
                if (file) {
                    currentImageFile = file;
                    const imageUrl = URL.createObjectURL(file);
                    imagePreview.src = imageUrl;

                    const img = new Image();
                    img.onload = () => {
                        const cellElement = gridContainer.querySelector(`[data-id="${activeCellId}"]`);
                        if (!cellElement) return;

                        const imageIsLandscape = img.naturalWidth > img.naturalHeight;
                        const cellIsLandscape = cellElement.clientWidth > cellElement.clientHeight;

                        currentRotation = (imageIsLandscape !== cellIsLandscape) ? 90 : 0;
                        imagePreview.style.transform = `rotate(${currentRotation}deg)`;
                        URL.revokeObjectURL(imageUrl);
                    };
                    img.src = imageUrl;
                }
            }

            function rotateImage() {
                currentRotation = (currentRotation + 90) % 360;
                imagePreview.style.transform = `rotate(${currentRotation}deg)`;
            }

            function removeImage() {
                currentImageFile = null;
                currentRotation = 0;
                imagePreview.src = '';
                imagePreview.style.transform = 'rotate(0deg)';
            }

            function saveImage() {
                const cellState = gridState[activeCellId];
                cellState.image.file = currentImageFile;
                cellState.image.rotation = currentRotation;
                cellState.image.url = currentImageFile ? URL.createObjectURL(currentImageFile) : null;
                renderGrid();
                closeModal();
            }

            // --- FUNCIONES DE UTILIDAD Y UI ---

            function updateActionButtons() {
                const selectedCount = selectedCellIds.size;
                mergeBtn.disabled = selectedCount < 2;
                splitBtn.disabled = true;

                if (selectedCount === 1) {
                    const selectedCell = gridState[selectedCellIds.values().next().value];
                    if (selectedCell && selectedCell.merged) {
                        splitBtn.disabled = false;
                    }
                }
            }
            
            // --- EVENT LISTENERS ---
            orientationSelect.addEventListener('change', render);
            pageSizeSelect.addEventListener('change', render);
            useHalfPageCheckbox.addEventListener('change', render);
            marginInput.addEventListener('input', render);
            spacingInput.addEventListener('input', renderGrid);
            window.addEventListener('resize', render);
            createGridBtn.addEventListener('click', createGrid);
            gridContainer.addEventListener('click', handleCellClick);
            mergeBtn.addEventListener('click', mergeCells);
            splitBtn.addEventListener('click', splitCell);
            generatePdfBtn.addEventListener('click', generatePdf);
            
            // Modal listeners
            imageInput.addEventListener('change', handleImageUpload);
            rotateBtn.addEventListener('click', rotateImage);
            removeBtn.addEventListener('click', removeImage);
            saveBtn.addEventListener('click', saveImage);
            cancelBtn.addEventListener('click', closeModal);

            // --- INICIALIZACIÓN ---
            createGrid();
        });
    </script>
</body>
</html>